<!DOCTYPE html>
<html>
  <head>
    <title>vastimg.heroku.com</title>
    <style>
      body {
        margin:0;
        padding:0;
        background:#000
      }
      img {
        position:absolute;
        top:0;
        left:0;
        height:100%;
        width:100%;
        border:0;
        /* secret to everything basically */
        image-rendering:-moz-crisp-edges;
        image-rendering:-webkit-optimize-contrast;
        -ms-interpolation-mode:nearest-neighbor
      }
      form {
        padding:30px;
        border:8px solid #000;
        background:#fff;
        position:absolute;
        width:25%;
        height:25%;
        top:33%;
        left:33%;
        opacity:0;
      }
      input {
        font-size:40px;
        opacity:1;
        width:90%;
        color:#fff;
        border:0;
      }
    </style>
  </head>
  <body>
    <img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==">
    <form><input type='text'></form>
    <script type="text/javascript">
      (function () {
        var query = document.location.search,
              src = query.substring(1, query.length),
              img = document.getElementsByTagName('img')[0],
             form = document.getElementsByTagName('form')[0],
            input = document.getElementsByTagName('input')[0],
              log = function(){console && console.log.apply(console, arguments)}

        img.src = src
        form.onsubmit = function () { return false }

        /* listen/unlisten for top-level keyboard events */
        function listen (func) {
          func = func || key
          document.onkeydown =
            function (ev) { return func(ev.keyCode) }
        }
        function unlisten () { document.onkeydown = null }

        /* process keyCode value */
        function key (code) {
          if (code == 32 || (code >= 37 && code <= 40)) {
            unlisten()
            location.href = '/'
          } else
            // log("key: ", ev.keyCode)
            ;
        }

        /* activate paste target input */
        function activateInput() {
          input.value = src
          input.style.display = 'block'
          listen()
          check()
          log("input activated")
        }
        activateInput()

        /* check paste target for new stuff, loss of focus */
        function check() {
          if (input.value != src) {
            unlisten()
            input.style.display = 'none'
            if (!receive(input.value)) {
              log('bzzt: ' + input.value)
              activateInput()
            }
            return
          }

          if (document.activeElement != input) {
            log('paste target lost focus')
            input.focus()
            input.select()
          }

          if (input.selectionStart > 0 || input.selectionEnd < src.length) {
            log("paste target lost selection")
            input.select()
          }

          setTimeout(check, 100)
        }

        function receive(text) {
          var url = text.trim(), match
          if (url.match(/^(?:https?|data):/)) {
            if (match = url.match(/^https?:\/\/vastimg\.herokuapp\.com\/\?(.*)/))
              url = match[1]
            location.href = '/?' + url
            return url
          }
        }

        log('paste me an img')
      })()
    </script>
  </body>
</html>
